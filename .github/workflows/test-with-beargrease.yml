name: Test with Beargrease

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: 📥 Checkout Placebo code
        uses: actions/checkout@v3

      - name: 📂 Prepare wallet volume mount
        run: mkdir -p .wallet-volume

      - name: 🧶 Install JavaScript Dependencies
        run: |
          echo "Installing JS dependencies..."
          yarn install

      - name: ⚓ Install Anchor CLI (with caching)
        id: install-anchor
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/bin/anchor
            ~/.config/solana
            ~/.local/share/solana
          key: anchor-cli-v0.29.0

      - name: 🧰 Install Anchor (if not cached)
        if: steps.install-anchor.outputs.cache-hit != 'true'
        run: |
          curl -sSf https://raw.githubusercontent.com/project-serum/anchor/master/scripts/install-anchor.sh | sh

      - name: ➕ Add Anchor to PATH
        run: echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: 🐻 Run Beargrease
        uses: rgmelvin/beargrease-by-cabrillo@v1.0.19
        with:
          wallet-secret: ${{ secrets.TEST_USER_KEYPAIR_B64 }}