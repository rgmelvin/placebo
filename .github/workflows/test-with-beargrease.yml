name: Test with Beargrease

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    env:
      TEST_RUNNER: auto  # 🧪 Ensures Beargrease uses anchor/yarn detection automatically

    steps:
      # Step 1: Checkout Placebo code
      - name: 📥 Checkout Placebo code
        uses: actions/checkout@v3

      # Step 2: Prepare .wallet-volume mount for Beargrease wallet injection
      - name: 📂 Prepare wallet volume mount
        run: mkdir -p .wallet-volume

      # Step 3: Set up Rust (needed before installing Anchor via cargo)
      - name: 🦀 Set up Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true

      # Step 4: Install Anchor CLI (via cargo, same as your Solana email CI)
      - name: ⚓ Install Anchor CLI (cargo)
        run: |
          cargo install --git https://github.com/coral-xyz/anchor --tag v0.31.1 anchor-cli --locked --force

      # Step 5: Confirm Anchor version
      - name: 📌 Confirm Anchor version
        run: anchor --version

      # Step 6: 💾 Cache Yarn dependencies to speed up builds
      - name: 💾 Cache Yarn dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.yarn/cache
            node_modules
          key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}

      # Step 7: Install JS dependencies
      - name: 🧶 Install JavaScript Dependencies
        run: yarn install

      # Step 8: Add node_modules/.bin to PATH for test runners
      - name: ➕ Add node_modules/.bin to PATH
        run: echo "$(pwd)/node_modules/.bin" >> $GITHUB_PATH

      # Step 9: 🐻 Run Beargrease test harness
      - name: 🐻 Run Beargrease
        uses: rgmelvin/beargrease-by-cabrillo@v1.0.20
        with:
          wallet-secret: ${{ secrets.TEST_USER_KEYPAIR_B64 }}
